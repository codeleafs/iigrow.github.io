
# javascript语言为什么慢

javascript是一种弱类型 动态检查语言

在静态类型语言中，编辑器已事先知道所存取的变量类型，所以语言解释系统，只要利用数组和位移来存取变量和方法的地址等，位移信息得它只要几个机器语言指令就可以存取变量，找出变量或执行其他任务。

C++与JavaScript对比

* 编译确定位置： C++有明确的两个阶段，而编译这些位置的偏移信息都是编译器在编译的时候就决定了的，当C++代码编译成本地代码之后，对象的属性和偏移位置都计算完成。JavaScript没有类型，所以只有在对象创建的时候才有这些信息，因而只能在执行阶段确定，而且JavaScript语言能够在执行时修改对象的属性

* 偏移信息共享： C++因为有类型定义，所以所有对象都是按照该类型来确定的，而且不能在执行的时候动态修改类型，因为这些对象都是共享偏移信息的。JavaScript每个对象会是自描述，属性和位置偏移信息都包含在自身的结构中。

* 偏移信息查找： C++中查找偏移地址很简单，都是在编译代码时，对使用某类型的成员变量直接设置偏移量。对于javaScript 使用到一个对象则需要通过属性名匹配才能查找到对应的值。

闭包 是一个拥有许多变量和绑定了这些变量的环境的表达式，因而这些变量也是该表达式的一部分

源码 --> 抽象语法树 --> 中间表示 --> 本地代码

javascript语言有个特性： 语言的编译执行都是在网页和javascript文件下载后同执行阶段一起在网页的加载和渲染过程中来实施的，所以对它们的处理也有很高的要求。

javascript对象的实现在v8中 包含3个成员，
  第一个是隐藏类的指针，这是v8为javascript对象创建的隐藏类。
  第二个指向对象包含的属性值。
  第三个指向包含的元素。

javascriptCore：
  从抽象语法树生成平台无关的字节码，在字节码执行期间，信息收集器会收集热点函数，以方便之后的JIT编译器做之后的优化处理。
  JSCore引擎在获悉热点函数后，需要对它们进行优化，使用 BaseLine JIT编译器，该编译器根据信息收集器1中的信息，将对应函数的字节码翻译成本地代码，这儿没有做过多的优化，而是直接转换，同时会有收集器2来收集代码并做进一步的优化。
  JSCore引入了DFG（Data-Flow Graph） JIT编译器，该编译器是在字节码基础上，生成基于SSA（Static Single Assignment）的中间表示，根据信息收集器2提供的信息重新生成优化的本地代码。

v8:  
  v8引擎通过JIT编译器的全代码生成器把抽象语法树直接生成本地代码，并不将抽象语法树转变成字节码或者其它中间表示。
  v8在生成本地代码之后，为了性能考虑，通过数据分析器采集一些信息，以帮助决策哪些本地代码需要优化，以生成效率更高的本地代码。
  v8当发现优化后的代码性能其实并没有提高甚至有所降低，那么v8能够回退到原来的代码。
  js函数被调用时先判断是否已经生成本地代码，如果已生成则直接调用，否则生成本地代码再进行调用。（延迟编译CompileLazy）
  v8的crankshaft编译器基于js源码开始分析，而不是本地代码，同时构建Hydrogen图并基于此来进行优化分析。
  为了性能考虑编译器通常会做出乐观和大胆的预测，那就是编译器认为某些代码较稳定，变量类型会发生改变，所以能够生成高效的本地代码，如果发现变量类型发生了变化，v8会回滚到之前的一般情况，称为优化回滚。

  v8使用类和偏移位置思想，将本来需要通过字符串匹配来查找属性值的算法改进为使用类似C++编译器的偏移位置的机制来实现，这就是隐藏类。隐藏类将对象划分成不同的组，对于相同的组（对象拥有相同的属性名和属性值），将这些属性名和对应的偏移位置保存在一个隐藏类中，组内的所有对象共享该信息。

  v8有一种缓存机制，叫内嵌缓存，基本思想是将使用之前查找的隐藏类和偏移值结果缓存起来，当下次查找的时候，首先比较当前对象是否也是之前的隐藏类，如果是的话直接使用缓存值。